---
title: "Model Estimated Controls for Survival Outcomes"
format: 
  html:
    self-contained: true
---

## Introduction

For survival outcomes, MECs can be used as a control to compare the effect of a control treatment against the effect of an observed experimental treatment on overall survival in patients.

We will implement MECs using the 'psc' package which specifically allows for the comparison of patient groups treated with an experimental treatment against a counterfactual model (CFM).

Load necessary packages:

```{r,warning=FALSE,results='hide',message=FALSE}
library(psc)
library(survival)
library(ggpubr)
```

## An example

In this example, we will look at survival outcomes in patients with pancreatic cancer from the ESPAC (European Study for Pancreatic Cancer)-4 trial and compare how the survival of patients differs with two different treatments: GEM Vs. GEMCAP...

Load the model that will act as the control treatment (CFM). This model is a flexible parametric model.

```{r,warning=FALSE,results='hide'}
load("Output/Models/flsm.R")

```

Now that we have our control treatment, monotherapy gemcitabine (GEM), we will load the ESPAC-4 dataset. ESPAC-4 consists of patients that have been treated with the experimental treatment, adjuvant gemcitabine and capecitabine, GEMCAP.

Our aim is to compare the ESPAC-4 dataset against the GEM model to determine which of the treatments is more effective.

```{r}

load("Data/espac4gemcap.R")

```

## Fit counterfactual model :)

We can turn the flexible parametric model into a CFM using the pscCFM() function:

```{r results='hide',warning=FALSE}
cfm <- pscCFM(flsm)

```

It is possible to visualise and summarise the data that was used to fit this model with the built in functions within pscCFM():

```{r}
#| label: fig_dataSumm_gem
cfm$datasumm$summ_Table

ggarrange(plotlist = cfm$datavis, ncol = 2)

```

## Make comparison!

The CFM can be compared against the ESPAC-4 data cohort. The comparison will be carried out using the pscfcit() function.

```{r results='hide',warning=FALSE}
psc <- pscfit(cfm, espac4_gemcap)
```

The plot below visualises the effect of each treatment on ESPAC-4 patients. The pink line represents the model's predicted survival estimates (if the ESPAC-4 patients had been treated with GEM) and the orange line represents the data cohort's observed survival estimates.

```{r}
#| label: plot_psc_surv_espac
plot(psc)
```

The summary of the model can be obtained using the generic summary() function to show the posterior density. The posterior estimates of the deviance information criterion (DIC) and the efficacy parameter, $\beta$, are calculated and shown.

$\beta$ is a measurement of the distance between the observed data and the model estimate. The 2.5 and 97.5% quantiles are also given. The odds ratio comparing the experimental treatment to the control can be calculated as exp($\beta$), in this case exp(-0.466452).

```{r}

summary(psc)
```

We can extract the posterior distribution of the 'psc' and can view its autocorrelation and trace

```{r}
#| label: posterior_psc_gem
posterior <- psc$posterior
head(posterior[1:3,])

# autocorrelation
acf(posterior$beta)

# trace
plot(posterior$beta, type = 's')

```

## More details!

-   More details on GEM model vs GEMCAP patients can be found at: https://richjjackson.github.io/mecPortal//applications/gem_gemcap_pdac.html

-   Code for tutorial is available: https://github.com/kusqaum/PDAC
